<!DOCTYPE html>
<html lang="en">

    <head>
        <meta charset="UTF-8">
        <title>Kshipra's AI Chatbot</title>

        <style>
            /* ------------------ Base ------------------ */
            body {
                margin: 0;
                background: #111b21;
                font-family: 'Segoe UI', Arial;
                display: flex;
                justify-content: center;
                align-items: center;
                height: 100vh;
            }

            .chat-container {
                width: 380px;
                height: 85vh;
                background: #0b141a;
                border-radius: 12px;
                display: flex;
                flex-direction: column;
                overflow: hidden;
                border: 1px solid #1f2c34;
                box-shadow: 0 0 18px rgba(0, 0, 0, .45);
            }

            /* ------------------ Header ------------------ */
            .header {
                background: #005c4b;
                color: #fff;
                padding: 12px;
                display: flex;
                align-items: center;
                gap: 10px;
                font-size: 16px;
                font-weight: 600;
                cursor: pointer;
            }

            .avatar {
                width: 36px;
                height: 36px;
                border-radius: 50%;
                object-fit: cover;
            }

            .bot-name {
                flex: 1;
            }

            #modeToggle,
            #clearChat {
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
                padding: 5px;
            }

            /* ------------------ Chat Area ------------------ */
            .chat-box {
                flex: 1;
                padding: 12px;
                overflow-y: auto;
                background: url('https://i.imgur.com/7v9F8fO.png') repeat;
                background-size: 300px;
                scrollbar-width: none;
            }

            .chat-box::-webkit-scrollbar {
                display: none;
            }

            .msg {
                display: inline-block;
                max-width: 80%;
                width: fit-content;
                padding: 8px 12px;
                border-radius: 10px;
                word-wrap: break-word;
                white-space: pre-wrap;
            }


            .you {
                background: #005c4b;
                color: #e9edef;
                margin-left: auto;
                border-bottom-right-radius: 0;
            }

            .bot {
                background: #202c33;
                color: #e9edef;
                margin-right: auto;
                border-bottom-left-radius: 0;
            }

            .time {
                font-size: 11px;
                color: #99a8ac;
                display: block;
                margin-top: 2px;
            }

            .msg-wrapper {
                position: relative;
            }

            .actions {
                position: absolute;
                bottom: 25px;
                right: 0;
                background: #2a3a42;
                padding: 6px 8px;
                border-radius: 6px;
                display: flex;
                gap: 6px;
                font-size: 15px;
                box-shadow: 0 0 10px rgba(0, 0, 0, .4);
                z-index: 5;
            }

            .actions span {
                cursor: pointer;
            }

            .hidden {
                display: none;
            }

            .msg.starred {
                border: 2px solid gold;
                background: #4d4a00c9;
            }

            .reaction {
                font-size: 18px;
                margin-top: 3px;
                display: block;
            }


            .msg-wrapper.right {
                text-align: right;
            }

            .msg-wrapper.left {
                text-align: left;
            }

            @keyframes pop {
                0% {
                    transform: scale(.9);
                    opacity: 0;
                }

                100% {
                    transform: scale(1);
                    opacity: 1;
                }
            }

            /* Typing */
            .typing-dots span {
                animation: blink 1.2s infinite;
                font-size: 18px;
            }

            .typing-dots span:nth-child(2) {
                animation-delay: .2s;
            }

            .typing-dots span:nth-child(3) {
                animation-delay: .4s;
            }

            @keyframes blink {

                0%,
                80% {
                    opacity: .2
                }

                50% {
                    opacity: 1
                }
            }

            /* ------------------ Input ------------------ */
            .input-area {
                display: flex;
                align-items: center;
                background: #1f2c34;
                padding: 10px;
                gap: 6px;
                flex-wrap: nowrap;
            }

            .emoji-btn {
                background: none;
                border: none;
                color: white;
                font-size: 22px;
                cursor: pointer;
            }

            .msg-box {
                flex: 1;
                display: flex;
                align-items: center;
                background: #2a3a42;
                border-radius: 25px;
                padding: 0 6px;
            }

            #msg {
                flex: 1;
                padding: 10px;
                border: none;
                border-radius: 25px;
                background: #2a3a42;
                color: white;
                outline: none;
                max-width: 160px;
                min-width: 120px;
                /* shortened input */
            }

            .send-btn {
                background: #00a884;
                border: none;
                padding: 8px 11px;
                margin-left: 4px;
                border-radius: 50%;
                color: white;
                cursor: pointer;
                font-size: 17px;
            }

            .send-btn:hover {
                background: #07c699
            }

            .input-area button {
                padding: 8px 10px;
                font-size: 11px;
                border-radius: 18px;
                white-space: nowrap;
                background: #005c4b;
                color: white;
                border: none;
                cursor: pointer;
            }

            .input-area button:hover {
                background: #017562
            }

            /* ------------------ Light Mode ------------------ */
            .light .header {
                background: #25d366;
            }

            .light .you {
                background: #dcf8c6;
                color: #111;
            }

            .light .bot {
                background: #f1f1f1;
                color: #000;
            }

            .light #msg {
                background: #fff;
                color: #111;
            }

            .light .chat-box {
                background: #e5ddd5;
            }

            .light .input-area {
                background: #d9dbdc;
            }

            /* ------------------ Profile Popup ------------------ */
            .popup {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, .55);
                backdrop-filter: blur(5px);
                display: flex;
                justify-content: center;
                align-items: center;
            }

            .hidden {
                display: none;
            }

            .popup-content {
                background: #202c33;
                width: 75%;
                padding: 25px;
                border-radius: 12px;
                text-align: center;
                color: white;
                animation: pop .25s ease-out;
            }

            .popup-avatar {
                width: 90px;
                height: 90px;
                border-radius: 50%;
                border: 3px solid #00a884;
                margin-bottom: 10px;
            }

            .close-btn {
                width: 100%;
                padding: 10px;
                margin-top: 10px;
                background: #005c4b;
                color: #fff;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 15px;
            }

            .close-btn:hover {
                background: #017562
            }

            /* ------------------ Toast ------------------ */
            .toast {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #00a884;
                color: white;
                padding: 10px 20px;
                border-radius: 20px;
                opacity: 0;
                transition: .35s;
                font-size: 14px;
                z-index: 999;
            }

            .toast.show {
                opacity: 1;
                bottom: 40px;
            }

            /* ------------------ Emoji Panel ------------------ */
            .emoji-box {
                position: absolute;
                bottom: 95px;
                right: 20px;
                width: 270px;
                max-height: 270px;
                background: #1f2c34;
                padding: 10px;
                border-radius: 10px;
                color: white;
                overflow-y: auto;
                scrollbar-width: none;
                animation: pop .25s;
            }

            .emoji-box::-webkit-scrollbar {
                display: none;
            }

            .emoji-category {
                color: #00a884;
                margin-top: 6px;
                font-size: 13px;
                font-weight: bold;
            }

            .emoji-grid {
                display: flex;
                flex-wrap: wrap;
                gap: 5px;
                font-size: 22px;
                cursor: pointer;
            }
        </style>
    </head>

    <body>

        <div class="chat-container">

            <div class="header" onclick="showProfile()">
                <img src="https://cdn-icons-png.flaticon.com/512/4712/4712100.png" class="avatar">
                <span class="bot-name">Kshipra's Chatbot</span>

                <button id="clearChat" onclick="clearHistory(event)">ğŸ—‘</button>
                <button id="modeToggle" onclick="event.stopPropagation();toggleMode()">ğŸŒ™</button>
            </div>

            <!-- Profile -->
            <div id="profilePopup" class="popup hidden" onclick="closeProfile(event)">
                <div class="popup-content">
                    <img src="https://cdn-icons-png.flaticon.com/512/4712/4712100.png" class="popup-avatar">
                    <h3>Kshipraâ€™s Chatbot</h3>
                    <p>ğŸŸ¢ Online</p>
                    <p style="opacity:.8">Friendly AI Assistant ğŸ˜Š</p>
                    <button class="close-btn" onclick="hideProfile()">Close</button>
                </div>
            </div>

            <div class="chat-box" id="chatbox">
                {% for msg in history %}
                <div class="msg-wrapper {% if msg.sender == 'user' %}right{% else %}left{% endif %}"
                    oncontextmenu="openMenu(event,this)" ondblclick="openMenu(event,this)">

                    <p class="msg {% if msg.sender == 'user' %}you{% else %}bot{% endif %}">
                        {{ msg.text }}
                    </p>

                    <div class="actions hidden">
                        <span onclick="copyMsg(this)">ğŸ“„</span>
                        <span onclick="deleteMsg(this)">ğŸ—‘</span>
                        <span onclick="starMsg(this)">â­</span>
                        <span onclick="react(this)">ğŸ˜Š</span>
                    </div>

                    <span class="reaction"></span>
                    <span class="time">{{ msg.timestamp|date:"h:i A" }}</span>
                </div>

                {% endfor %}
            </div>

            <!-- Input bar -->
            <div class="input-area">
                <button onclick="toggleEmoji()" class="emoji-btn">ğŸ˜Š</button>

                <div class="msg-box">
                    <input id="msg" placeholder="Type message..." autofocus>
                    <button class="send-btn" onclick="sendMsg()">ğŸ“¤</button>
                </div>

                <button onclick="downloadTXT()">TXT</button>
                <button onclick="downloadPDF()">PDF</button>
            </div>

            <!-- Emoji Picker -->
            <div id="emojiBox" class="emoji-box hidden">
                <div class="emoji-category">ğŸ˜Š Smileys</div>
                <div class="emoji-grid">ğŸ˜€ ğŸ˜„ ğŸ˜ ğŸ˜† ğŸ˜‚ ğŸ˜Š ğŸ˜‰ ğŸ˜ ğŸ˜˜ ğŸ˜š ğŸ˜‹ ğŸ˜œ ğŸ¤ª ğŸ¤” ğŸ™‚ ğŸ˜ ğŸ¤© ğŸ¥³ ğŸ˜ ğŸ˜ª ğŸ˜´ ğŸ˜µâ€ğŸ’« ğŸ¤¯ ğŸ¥º ğŸ˜¢ ğŸ˜­
                    ğŸ˜¡ ğŸ¤¬ ğŸ˜° ğŸ˜¨ ğŸ˜± ğŸ˜³ ğŸ˜¤</div>

                <div class="emoji-category">â¤ï¸ Love</div>
                <div class="emoji-grid">â¤ï¸ ğŸ’– ğŸ’˜ ğŸ’ ğŸ’“ ğŸ’ ğŸ’• ğŸ’— â£ ğŸ’Ÿ</div>

                <div class="emoji-category">ğŸ‘ Gestures</div>
                <div class="emoji-grid">ğŸ‘ ğŸ‘ ğŸ™Œ ğŸ‘ ğŸ¤ ğŸ«¶ âœŒ ğŸ¤ ğŸ¤˜ ğŸ™ ğŸ– ğŸ«µ ğŸ‘Œ</div>

                <div class="emoji-category">ğŸ”¥ Fun</div>
                <div class="emoji-grid">ğŸ”¥ ğŸ‰ ğŸ¥³ ğŸŠ ğŸˆ ğŸ® ğŸ§ ğŸ¤ ğŸ† âš½ ğŸ ğŸ€</div>

                <div class="emoji-category">ğŸŒ¿ Nature</div>
                <div class="emoji-grid">ğŸŒ ğŸŒ› â­ âœ¨ ğŸŒˆ ğŸŒ§ â„ ğŸŒŠ ğŸŒµ ğŸŒ´ ğŸŒ¸ ğŸŒ¹</div>

                <div class="emoji-category">ğŸ½ Food</div>
                <div class="emoji-grid">ğŸ• ğŸ” ğŸŸ ğŸŒ­ ğŸ— ğŸ¿ ğŸ° ğŸ© ğŸ ğŸ‰ ğŸ“</div>
            </div>
        </div>

        <div id="toast" class="toast">...</div>

        <script>
            const sendSound = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-message-pop-alert-2354.mp3");
            const receiveSound = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-long-pop-2358.mp3");

            function sendMsg() {
                let msg = document.getElementById("msg").value.trim();
                if (!msg) return; let box = document.getElementById("chatbox");

                box.innerHTML += `<div class="msg-wrapper right"><p class="msg you">${msg}</p><span class="time">${time()}</span></div>`;
                sendSound.play(); document.getElementById("msg").value = ""; box.scrollTop = box.scrollHeight;

                let typing = document.createElement("div");
                typing.id = "typing"; typing.innerHTML = `<div class="msg-wrapper left"><p class="msg bot"><span class="typing-dots"><span>.</span><span>.</span><span>.</span></span></p></div>`;
                box.appendChild(typing);

                fetch("/api/chat/", {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: "message=" + encodeURIComponent(msg)
                })
                    .then(r => r.json()).then(data => {
                        typing.remove();
                        box.innerHTML += `<div class="msg-wrapper left"><p class="msg bot">${data.bot_reply}</p><span class="time">${time()}</span></div>`;
                        receiveSound.play(); box.scrollTop = box.scrollHeight;
                    });
            }

            document.getElementById("msg").addEventListener("keydown", e => { if (e.key === "Enter") sendMsg(); });

            /* clear chat */
            function clearHistory(e) {
                e.stopPropagation();
                fetch("/clear-chat/", { method: "POST" }).then(r => r.json()).then(() => {
                    document.getElementById("chatbox").innerHTML = "";
                    toast("Chat cleared ğŸ—‘");
                });
            }

            /* toast */
            function toast(t) { let x = document.getElementById("toast"); x.innerText = t; x.classList.add("show"); setTimeout(() => x.classList.remove("show"), 2200); }

            /* UI controls */
            function showProfile() { profilePopup.classList.remove("hidden") }
            function hideProfile() { profilePopup.classList.add("hidden") }
            function closeProfile(e) { if (e.target.id == "profilePopup") hideProfile() }
            function toggleMode() { document.body.classList.toggle("light") }
            function downloadTXT() { window.location = "/export/txt/" }
            function downloadPDF() { window.location = "/export/pdf/" }
            function time() { return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }) }
            function toggleEmoji() { emojiBox.classList.toggle("hidden") }

            /* insert emoji single click */
            /* insert emoji into input */
            document.getElementById("emojiBox").addEventListener("click", function (e) {
                if (e.target.classList.contains("emoji-item")) {
                    msg.value += e.target.textContent;
                    msg.focus();
                }
            });

            /* Convert emoji text into clickable spans */
            window.addEventListener("DOMContentLoaded", () => {
                document.querySelectorAll(".emoji-grid").forEach(grid => {
                    let html = "";
                    grid.innerText.trim().split(/\s+/).forEach(e => {
                        html += `<span class="emoji-item">${e}</span>`;
                    });
                    grid.innerHTML = html; // replace content with span-wrapped emojis
                });
            });

            function openMenu(event, msgBox) {
                event.preventDefault();
                document.querySelectorAll(".actions").forEach(a => a.classList.add("hidden"));
                msgBox.querySelector(".actions").classList.toggle("hidden");
            }

            // COPY TEXT
            function copyMsg(btn) {
                let text = btn.closest(".msg-wrapper").querySelector(".msg").innerText;
                navigator.clipboard.writeText(text);
                toast("Copied ğŸ“‹");
            }

            // DELETE ONLY ONE MESSAGE
            function deleteMsg(btn) {
                btn.closest(".msg-wrapper").remove();
                toast("Deleted ğŸ—‘");
            }

            // STAR MESSAGE
            function starMsg(btn) {
                let msg = btn.closest(".msg-wrapper").querySelector(".msg");
                msg.classList.toggle("starred");
                toast(msg.classList.contains("starred") ? "Starred â­" : "Unstarred");
            }

            // REACTION POPUP
            function react(btn) {
                let reactions = "â¤ï¸ ğŸ‘ ğŸ˜‚ ğŸ”¥ ğŸ˜®";
                let box = document.createElement("div");
                box.className = "actions";
                box.innerHTML = reactions.split(" ").map(e => `<span onclick="setReact(this)">${e}</span>`).join("");
                btn.closest(".msg-wrapper").appendChild(box);
            }

            function setReact(e) {
                let msg = e.closest(".msg-wrapper");
                msg.querySelector(".reaction").innerText = e.innerText;
                msg.querySelector(".actions").remove();
            }

        </script>
    </body>

</html>